<!DOCTYPE html>
<html>
  
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title></title>
    
    <link rel="stylesheet" href="_css.css">
    <link rel="stylesheet" href="src/view/_css.css">
    <link rel="stylesheet" href="src/lib/view/_css.css">
    <link rel="stylesheet" href="src/lib/view/browser/_css.css">
    <link rel="stylesheet" href="src/lib/view/fields/_css.css">
    
  </head>
  
		
<script>

	var ObjectCloneFunction = function() {
		var constructor = new Function;
		constructor.prototype = this;
		var instance = new constructor;
		if (instance.init) {
			instance.init()
		}
		return instance
	}

	JSScript = {
		_fullPath: null,
		_doneCallback: null,
		
		fullPath: function() {
			return this._fullPath
		},
		
		setDoneCallback: function(callback) {
			this._doneCallback = callback
			return this
		},
		
		clone: ObjectCloneFunction,
		
		setFullPath: function(aPath) {
			this._fullPath = aPath
			return this
		},
		
		run: function() {
		    var script = document.createElement('script');
		    script.src = this._fullPath;
			//console.log("JSScript " + this._fullPath)
	
		    script.onload = () => {
				this._doneCallback()
		    }
	
		    script.onerror = (error) => {
				throw new Error("missing url " + this._fullPath)
		    }

		    var parent = document.getElementsByTagName('head')[0] || document.body;
		    parent.appendChild(script)			
		},
		
		basePath: function() {
			var parts = this.fullPath().split("/")
			parts.pop()
			var basePath = parts.join("/")
			//console.log("basePath = " + basePath)
			
			return basePath
		},
	},
	
	function arrayInsertAt(destArray, pos, arrayToInsert) {
	    var args = [];
	    args.push(pos);                           // where to insert
	    args.push(0);                             // nothing to remove
	    args = args.concat(arrayToInsert);        // add on array to insert
	    destArray.splice.apply(destArray, args);  // splice it in
	}

	JSImporter = {
		_currentScript: null,
		_urls: [],
		_doneCallback: null,
	
		clone: ObjectCloneFunction,

		currentScriptPath: function() {
			if (this._currentScript) {
				return this._currentScript.basePath()
			}
			return ""
		},
		
		absolutePathForRelativePath: function(aPath) {
			var parts = this.currentScriptPath().split("/").concat(aPath.split("/")) 
			var rPath = parts.join("/")
			
			if (rPath[0] == "/"[0]) {
				rPath = "." + rPath
			}
			
			if (aPath.includes("imports")) {
			//	console.log("        " + aPath + " [" + this.currentScriptPath() + "] -> " + rPath)
			}
			
			return rPath
		},	
			
		absolutePathsForRelativePaths: function(paths) {
			return paths.map((aPath) => { return this.absolutePathForRelativePath(aPath) })
		},

		pushRelativePaths: function(paths) {
			this.pushFilePaths(this.absolutePathsForRelativePaths(paths))
			return this
		},
				
		pushRelativePath: function(aPath) {
			this.pushPath(this.absolutePathForRelativePath(aPath))
			return this
		},
			
		pushFilePaths: function(paths) {
			this._urls = paths.concat(this._urls)
			return this
		},
		
		pushPath: function(aPath) {
			this.pushFilePaths([aPath])
			return this
		},

		urls: function() {
			return this._urls
		},
	
		setUrls: function(urls) {
			this._urls = urls
			return this
		},
	
		addUrl: function(url) {
			this._urls.push(url)
			return this
		},
	
		setDoneCallback: function(callback) {
			this._doneCallback = callback
			return this
		},
	
		run: function() {
		    this.loadNext();
		},
	
		isDone: function() {
			return this.urls().length == 0	
		},
		
		loadNext: function() {
			if (!this.isDone()) {
		        var url = this._urls.shift();
				//var url = this.path().split("/").concat( url.split("/")).join("/")
				//console.log("loading " + url)
				this.loadUrl(url)
			} else {
				this.done()
			}
			return this
		},
	
		loadUrl: function(url) {
			this._currentScript = JSScript.clone().setFullPath(url).setDoneCallback(() => { this.loadNext() })
			//console.log("this._currentScript = ", this._currentScript)
			this._currentScript.run()
			return this	
		},
	
		done: function() {
			if (this._doneCallback) {
				this._doneCallback()
	        }
		},

	}

	JSImporter.pushPath("_imports.js").setDoneCallback(function () {
		sjcl.random.startCollectors();
        App.shared()
	}).run()
	
	
          
</script>
  


    </head>

    <body id="body">
      <div class="window">
        <div id="window-content" class="window-content">
        </div>
      </div>
    </body>
  
</html>
