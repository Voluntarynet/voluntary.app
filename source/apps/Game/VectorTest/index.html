<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=3, minimum-scale=0.1">
        <style type="text/css">

        html, body {
            background-color: black;
            color: white;
            font-family: "AppLight";
            text-shadow: 0px 0px 1px white, 0px 0px 3px white, 0 0 5px white;
            letter-spacing: 1px;
            height: 100%;
            margin: 0;
            padding: 0;
        }
        
    </style>
    
    <script type="text/javascript" src="three.js"></script>

  </head>
  <body>
    <svg id="mySVG" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"  width=100% height=100%>
        <!--
        <circle cx="30" cy="20" r="0.4" fill="rgba(255, 255, 255, 0.8)"/>
        -->
    </svg>


<script>
    
    if (!String.prototype.capitalized) {
        String.prototype.capitalized = function () {
            return this.replace(/\b[a-z]/g, function (match) {
                return match.toUpperCase();
            });
        }
    }
    
    class ObjectBase {

        static shared() {
            if (!this._shared) {
                this._shared = this.clone()
            }
            return this._shared
        }

        type() {
            return this.constructor.name
        }

        static clone() {
            const obj = new this()
            obj.init()
            return obj
        }
    
        init() {
            // subclasses should override to initialize
        }

        newSlot(slotName, initialValue) {
            if (typeof(slotName) !== "string") {
                throw new Error("slot name must be a string"); 
            }

            if (initialValue === undefined) { 
                initialValue = null 
            };

            const privateName = "_" + slotName;
            this[privateName] = initialValue;

            if (!this[slotName]) {
                this[slotName] = function () {
                    return this[privateName];
                }
            }

            const setterName = "set" + slotName.capitalized()

            if (!this[setterName]) {
                this[setterName] = function (newValue) {
                    this[privateName] = newValue;
                    //this.updateSlot(slotName, privateName, newValue);
                    return this;
                }
            }

            return this;
        }
    }
    
    class SVGCircle extends ObjectBase {
        init() {
            super.init()
            this.newSlot("element", null);
            this.newSlot("position", new THREE.Vector3())
            this.newSlot("x", 0);
            this.newSlot("y", 0);
            this.newSlot("radius", 10);
            this.newSlot("fill", "white");
            this.createElement()
        }
        
        setX(v) {
            this._x = v;
            this.element().setAttributeNS(null,"cx", v);
            return this
        }
        
        setY(v) {
            this._y = v;
            this.element().setAttributeNS(null,"cy", v);
            return this
        }
        
        setRadius(v) {
            this._radius = v
            this.element().setAttributeNS(null,"r", v);
            return this
        }
        
        setFill(v) {
            this._fill = v;
            this.element().setAttributeNS(null,"fill", v);
            return this
        }
        
        createElement() {
            var svgNS = "http://www.w3.org/2000/svg";  
            var e = document.createElementNS(svgNS, "circle"); //to create a circle. for rectangle use "rectangle"
            //e.setAttributeNS(null,"id","mycircle");
            e.setAttributeNS(null,"cx", this.x());
            e.setAttributeNS(null,"cy", this.y());
            e.setAttributeNS(null,"r", this.radius());
            e.setAttributeNS(null,"fill", this.fill());
            e.setAttributeNS(null,"stroke","none");
            e.style.position = "absolute"
            this.setElement(e)
            document.getElementById("mySVG").appendChild(e);
            return this
        }     
        

        mapToScreen() {
            const w = window.renderer.domElement.clientWidth;
            const h = window.renderer.domElement.clientHeight;
            const p = this.position()
            const v1 = new THREE.Vector3().set(p.x, p.y, p.z)
            const v = v1.project(window.camera);

            v.x = Math.round( (v.x + 1) / 2 * w);
            v.y = Math.round(-(v.y - 1) / 2 * h);
            this.setX(v.x)
            this.setY(v.y)
            return this;
        }
        
    
        show() {
            const v = this.position()
            console.log("3d position: " + v.x + ", " + v.y + ", " + v.z)
            console.log("  screen xy: " + this.x() + ", " + this.y())
            return this
        }
    
    }
    
    class DemoApp extends ObjectBase {
        init() {
            super.init()
            this.setup()
        }
        
        setup () {
            window.scene = new THREE.Scene();
            window.camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        
            camera.position.set(30,30,0);
            camera.up = new THREE.Vector3(0,0,1);
            camera.lookAt(new THREE.Vector3(0,0,0));
            
            window.renderer = new THREE.WebGLRenderer();
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.domElement.style.visibility = "hidden"; 
            document.body.appendChild( renderer.domElement );
        }

        run () {
            const p = new THREE.Vector3().set(20, 20, 30)
            this._c1 = SVGCircle.clone().setX(p.x).setY(p.y).setFill("red").show()
        
            this._c2 = SVGCircle.clone().setFill("white")
            this._c2.position().set(p.x, p.y, p.z)
            this._c2.mapToScreen()
            this._c2.show()
        
            //this.startTimer()
        }
        
        startTimer() {
            this._timerId = setInterval(() => {
                this.nextStep()
            }, 1000/30)            
        }
        
        stopTimer() {
            clearInterval(this._timerId);
        }
        
        nextStep() {
            const p = this._c2.position()
            p.set(p.x + 1, p.y, p.z + 1) 
            this._c2.mapToScreen()
            this._c2.show()            
        }
    }

    
    window.onload = function(e) { 
        DemoApp.clone().run()
    }
    
</script>


  </body>
</html>